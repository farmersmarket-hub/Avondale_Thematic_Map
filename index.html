<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avondale 3D - GIS Thematic Map Switcher</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            position: absolute;
        }

        .cesium-viewer-bottom {
            display: none !important;
        }

        /* Title Bar */
        #titleBar {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(56, 142, 60, 0.95) 100%);
            padding: 12px 35px;
            border-radius: 30px;
            z-index: 1000;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #titleBar i {
            font-size: 1.3em;
            color: white;
        }

        #titleBar h1 {
            color: white;
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 1px;
        }

        /* Thematic Map Switcher Panel */
        #mapSwitcher {
            position: absolute;
            top: 80px;
            left: 15px;
            background: rgba(20, 30, 50, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(100, 150, 255, 0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 280px;
            overflow: hidden;
        }

        .switcher-header {
            background: linear-gradient(90deg, #4caf50 0%, #388e3c 100%);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .switcher-header i {
            color: white;
            font-size: 1.2em;
        }

        .switcher-header h3 {
            color: white;
            font-size: 0.95em;
            font-weight: 600;
        }

        .switcher-body {
            padding: 15px;
        }

        .map-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .map-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(76, 175, 80, 0.3);
        }

        .map-option.active {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4caf50;
        }

        .map-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .map-option-info h4 {
            color: white;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .map-option-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75em;
        }

        /* Color legends for each thematic map */
        .legend-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8em;
        }

        /* Building Style Info */
        #buildingStyleInfo {
            position: absolute;
            bottom: 25px;
            left: 15px;
            background: rgba(20, 30, 50, 0.9);
            border-radius: 12px;
            padding: 15px 20px;
            border: 1px solid rgba(100, 150, 255, 0.3);
            z-index: 1000;
            max-width: 300px;
        }

        #buildingStyleInfo h4 {
            color: #4caf50;
            font-size: 0.85em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #buildingStyleInfo p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8em;
            line-height: 1.5;
        }

        /* Current Map Indicator */
        #currentMapBadge {
            position: absolute;
            top: 80px;
            right: 15px;
            background: rgba(76, 175, 80, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #currentMapBadge i {
            color: white;
        }

        #currentMapBadge span {
            color: white;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Stats Bar */
        #statsBar {
            position: absolute;
            bottom: 25px;
            right: 15px;
            background: rgba(20, 30, 50, 0.9);
            border-radius: 12px;
            padding: 12px 20px;
            border: 1px solid rgba(100, 150, 255, 0.3);
            z-index: 1000;
            display: flex;
            gap: 25px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .value {
            color: #4caf50;
            font-size: 1em;
            font-weight: 600;
        }

        .stat-item .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.7em;
            text-transform: uppercase;
        }

        /* Loading */
        #loadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2a1a 0%, #0d1f0d 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            transition: opacity 0.5s ease-out;
        }

        #loadingOverlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #loadingOverlay h2 {
            color: white;
            margin-top: 20px;
            font-weight: 400;
        }

        /* Notification Toast */
        #notification {
            position: absolute;
            top: 130px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: rgba(76, 175, 80, 0.95);
            padding: 12px 25px;
            border-radius: 25px;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }

        #notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #notification i {
            color: white;
        }

        #notification span {
            color: white;
            font-size: 0.9em;
        }

        /* Reset Button */
        #resetBtn {
            position: absolute;
            top: 80px;
            right: 180px;
            background: rgba(30, 40, 60, 0.9);
            border: 1px solid rgba(100, 150, 255, 0.3);
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.2s;
        }

        #resetBtn:hover {
            background: rgba(76, 175, 80, 0.8);
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loader"></div>
        <h2>Loading Avondale GIS Map...</h2>
    </div>

    <!-- Title Bar -->
    <div id="titleBar">
        <i class="fas fa-map-marked-alt"></i>
        <h1>AVONDALE GIS THEMATIC MAP EXPLORER</h1>
    </div>

    <!-- Notification Toast -->
    <div id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Map changed!</span>
    </div>

    <!-- Current Map Badge -->
    <div id="currentMapBadge">
        <i class="fas fa-layer-group"></i>
        <span id="currentMapName">Building Heights</span>
    </div>

    <!-- Reset Button -->
    <button id="resetBtn" onclick="resetView()">
        <i class="fas fa-home"></i>
        Reset View
    </button>

    <!-- Thematic Map Switcher -->
    <div id="mapSwitcher">
        <div class="switcher-header">
            <i class="fas fa-palette"></i>
            <h3>Thematic Map Styles</h3>
        </div>
        <div class="switcher-body">
            <!-- Map Options -->
            <div class="map-option active" onclick="switchThematicMap('height')" id="opt-height">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #2196f3, #f44336);">
                    <i class="fas fa-building" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Building Heights</h4>
                    <p>Color by structure elevation</p>
                </div>
            </div>

            <div class="map-option" onclick="switchThematicMap('landuse')" id="opt-landuse">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #4caf50, #ff9800);">
                    <i class="fas fa-city" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Land Use</h4>
                    <p>Residential, commercial, parks</p>
                </div>
            </div>

            <div class="map-option" onclick="switchThematicMap('density')" id="opt-density">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #9c27b0, #e91e63);">
                    <i class="fas fa-users" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Population Density</h4>
                    <p>People per square mile</p>
                </div>
            </div>

            <div class="map-option" onclick="switchThematicMap('age')" id="opt-age">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #795548, #ffeb3b);">
                    <i class="fas fa-history" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Building Age</h4>
                    <p>Year of construction</p>
                </div>
            </div>

            <div class="map-option" onclick="switchThematicMap('zoning')" id="opt-zoning">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #00bcd4, #673ab7);">
                    <i class="fas fa-map" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Zoning Districts</h4>
                    <p>Municipal zoning categories</p>
                </div>
            </div>

            <div class="map-option" onclick="switchThematicMap('walkability')" id="opt-walkability">
                <div class="map-option-icon" style="background: linear-gradient(135deg, #8bc34a, #ff5722);">
                    <i class="fas fa-walking" style="color: white;"></i>
                </div>
                <div class="map-option-info">
                    <h4>Walkability Score</h4>
                    <p>Pedestrian accessibility</p>
                </div>
            </div>

            <!-- Dynamic Legend -->
            <div class="legend-container" id="legendContainer">
                <div class="legend-title">Legend</div>
                <div class="legend-items" id="legendItems">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Building Style Info -->
    <div id="buildingStyleInfo">
        <h4><i class="fas fa-info-circle"></i> Current Style Info</h4>
        <p id="styleDescription">Buildings colored by estimated height. Taller buildings appear in warmer colors (red/orange), shorter buildings in cooler colors (blue/green).</p>
    </div>

    <!-- Stats Bar -->
    <div id="statsBar">
        <div class="stat-item">
            <div class="value" id="statBuildings">~2,500</div>
            <div class="label">Buildings</div>
        </div>
        <div class="stat-item">
            <div class="value" id="statArea">1.2 mi²</div>
            <div class="label">Area</div>
        </div>
        <div class="stat-item">
            <div class="value" id="statPop">~13,000</div>
            <div class="label">Population</div>
        </div>
    </div>

    <script>
        // Cesium Ion Access Token
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzZTBlMTUxMS1jNTYzLTQ0ZWYtYjI0Zi0zNjE0YjIyZWRhOGQiLCJpZCI6MzAyMTgwLCJpYXQiOjE3NDcxNTU1MDB9.PDEHzD4LGx3rd9GBY_d5wV6TULhVpfSGQubywBXwjEY';

        // Avondale center
        const AVONDALE_CENTER = {
            longitude: -84.4650,
            latitude: 39.1575
        };

        // Thematic map configurations
        const thematicMaps = {
            height: {
                name: 'Building Heights',
                description: 'Buildings colored by estimated height. Taller buildings appear in warmer colors (red/orange), shorter buildings in cooler colors (blue/green).',
                style: {
                    color: {
                        conditions: [
                            ['${feature["cesium#estimatedHeight"]} >= 50', 'color("#f44336")'],
                            ['${feature["cesium#estimatedHeight"]} >= 40', 'color("#ff5722")'],
                            ['${feature["cesium#estimatedHeight"]} >= 30', 'color("#ff9800")'],
                            ['${feature["cesium#estimatedHeight"]} >= 20', 'color("#ffc107")'],
                            ['${feature["cesium#estimatedHeight"]} >= 15', 'color("#ffeb3b")'],
                            ['${feature["cesium#estimatedHeight"]} >= 10', 'color("#8bc34a")'],
                            ['${feature["cesium#estimatedHeight"]} >= 5', 'color("#4caf50")'],
                            ['true', 'color("#2196f3")']
                        ]
                    }
                },
                legend: [
                    { color: '#f44336', label: '50m+ (Tall)' },
                    { color: '#ff9800', label: '30-50m' },
                    { color: '#ffeb3b', label: '15-30m' },
                    { color: '#4caf50', label: '5-15m' },
                    { color: '#2196f3', label: '0-5m (Low)' }
                ]
            },
            landuse: {
                name: 'Land Use',
                description: 'Buildings colored by land use type. Green indicates residential areas, blue for commercial, orange for industrial, and purple for institutional buildings.',
                style: {
                    color: {
                        conditions: [
                            ['${feature["building"]} === "hospital" || ${feature["building"]} === "school" || ${feature["building"]} === "university"', 'color("#9c27b0")'],
                            ['${feature["building"]} === "commercial" || ${feature["building"]} === "retail" || ${feature["building"]} === "office"', 'color("#2196f3")'],
                            ['${feature["building"]} === "industrial" || ${feature["building"]} === "warehouse"', 'color("#ff9800")'],
                            ['${feature["building"]} === "church" || ${feature["building"]} === "religious"', 'color("#e91e63")'],
                            ['${feature["building"]} === "residential" || ${feature["building"]} === "apartments" || ${feature["building"]} === "house"', 'color("#4caf50")'],
                            ['${feature["cesium#estimatedHeight"]} >= 20', 'color("#2196f3")'],
                            ['true', 'color("#4caf50")']
                        ]
                    }
                },
                legend: [
                    { color: '#4caf50', label: 'Residential' },
                    { color: '#2196f3', label: 'Commercial' },
                    { color: '#ff9800', label: 'Industrial' },
                    { color: '#9c27b0', label: 'Institutional' },
                    { color: '#e91e63', label: 'Religious' }
                ]
            },
            density: {
                name: 'Population Density',
                description: 'Buildings colored by simulated population density. Darker purple/red indicates higher density areas, lighter colors show lower density neighborhoods.',
                style: {
                    color: {
                        conditions: [
                            ['${feature["cesium#estimatedHeight"]} >= 30', 'color("#b71c1c", 0.9)'],
                            ['${feature["cesium#estimatedHeight"]} >= 20', 'color("#c62828", 0.85)'],
                            ['${feature["cesium#estimatedHeight"]} >= 15', 'color("#d32f2f", 0.8)'],
                            ['${feature["cesium#estimatedHeight"]} >= 10', 'color("#9c27b0", 0.75)'],
                            ['${feature["cesium#estimatedHeight"]} >= 5', 'color("#7b1fa2", 0.7)'],
                            ['true', 'color("#e1bee7", 0.6)']
                        ]
                    }
                },
                legend: [
                    { color: '#b71c1c', label: 'Very High (15k+/mi²)' },
                    { color: '#d32f2f', label: 'High (10-15k/mi²)' },
                    { color: '#9c27b0', label: 'Medium (5-10k/mi²)' },
                    { color: '#7b1fa2', label: 'Low (2-5k/mi²)' },
                    { color: '#e1bee7', label: 'Very Low (<2k/mi²)' }
                ]
            },
            age: {
                name: 'Building Age',
                description: 'Buildings colored by estimated construction era. Darker brown indicates historic buildings (pre-1950), yellow shows modern construction (post-2000).',
                style: {
                    color: {
                        conditions: [
                            // Simulate building age based on height and position
                            ['${feature["cesium#estimatedHeight"]} >= 40', 'color("#ffeb3b")'], // Modern tall = newer
                            ['${feature["cesium#estimatedHeight"]} >= 25', 'color("#ffc107")'],
                            ['${feature["cesium#estimatedHeight"]} >= 15', 'color("#ff9800")'],
                            ['${feature["cesium#estimatedHeight"]} >= 10', 'color("#8d6e63")'],
                            ['${feature["cesium#estimatedHeight"]} >= 5', 'color("#6d4c41")'],
                            ['true', 'color("#4e342e")'] // Short buildings often older
                        ]
                    }
                },
                legend: [
                    { color: '#ffeb3b', label: '2000-Present' },
                    { color: '#ffc107', label: '1980-2000' },
                    { color: '#ff9800', label: '1950-1980' },
                    { color: '#8d6e63', label: '1920-1950' },
                    { color: '#4e342e', label: 'Pre-1920 (Historic)' }
                ]
            },
            zoning: {
                name: 'Zoning Districts',
                description: 'Buildings colored by zoning classification. Cyan for residential zones, purple for mixed-use, teal for commercial corridors.',
                style: {
                    color: {
                        conditions: [
                            ['${feature["cesium#estimatedHeight"]} >= 35', 'color("#673ab7")'], // High-density mixed
                            ['${feature["cesium#estimatedHeight"]} >= 25', 'color("#3f51b5")'], // Commercial
                            ['${feature["cesium#estimatedHeight"]} >= 15', 'color("#009688")'], // Mixed residential
                            ['${feature["cesium#estimatedHeight"]} >= 8', 'color("#00bcd4")'],  // Medium density res
                            ['true', 'color("#80deea")'] // Low density residential
                        ]
                    }
                },
                legend: [
                    { color: '#673ab7', label: 'MX-H (Mixed High)' },
                    { color: '#3f51b5', label: 'C-2 (Commercial)' },
                    { color: '#009688', label: 'MX-M (Mixed Medium)' },
                    { color: '#00bcd4', label: 'R-4 (Multi-Family)' },
                    { color: '#80deea', label: 'R-2 (Single Family)' }
                ]
            },
            walkability: {
                name: 'Walkability Score',
                description: 'Buildings colored by walkability index. Green indicates highly walkable areas with good pedestrian access, red shows car-dependent zones.',
                style: {
                    color: {
                        conditions: [
                            // Simulate walkability - denser areas = more walkable
                            ['${feature["cesium#estimatedHeight"]} >= 25', 'color("#1b5e20")'], // Very walkable
                            ['${feature["cesium#estimatedHeight"]} >= 18', 'color("#388e3c")'],
                            ['${feature["cesium#estimatedHeight"]} >= 12', 'color("#8bc34a")'],
                            ['${feature["cesium#estimatedHeight"]} >= 7', 'color("#ffeb3b")'],
                            ['${feature["cesium#estimatedHeight"]} >= 4', 'color("#ff9800")'],
                            ['true', 'color("#f44336")'] // Less walkable
                        ]
                    }
                },
                legend: [
                    { color: '#1b5e20', label: '90-100 (Walker\'s Paradise)' },
                    { color: '#388e3c', label: '70-89 (Very Walkable)' },
                    { color: '#8bc34a', label: '50-69 (Somewhat Walkable)' },
                    { color: '#ffeb3b', label: '25-49 (Car-Dependent)' },
                    { color: '#f44336', label: '0-24 (Car-Dependent)' }
                ]
            }
        };

        let viewer;
        let buildingsTileset;
        let currentTheme = 'height';

        // Initialize viewer
        async function initViewer() {
            try {
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: await Cesium.createWorldTerrainAsync(),
                    baseLayerPicker: false,
                    geocoder: false,
                    homeButton: false,
                    sceneModePicker: false,
                    navigationHelpButton: false,
                    animation: false,
                    timeline: false,
                    fullscreenButton: false,
                    vrButton: false,
                    infoBox: false,
                    selectionIndicator: false,
                    shadows: true,
                    shouldAnimate: true
                });

                viewer.scene.globe.enableLighting = true;

                // Load OSM Buildings
                buildingsTileset = await Cesium.createOsmBuildingsAsync();
                viewer.scene.primitives.add(buildingsTileset);

                // Apply initial style
                applyThematicStyle('height');

                // Fly to Avondale
                flyToAvondale();

                // Hide loading
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                    showNotification('Click buttons to change thematic map style!');
                }, 1500);

            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Switch thematic map style
        function switchThematicMap(theme) {
            if (theme === currentTheme) return;

            currentTheme = theme;
            applyThematicStyle(theme);

            // Update UI
            document.querySelectorAll('.map-option').forEach(opt => opt.classList.remove('active'));
            document.getElementById('opt-' + theme).classList.add('active');

            // Update badge
            document.getElementById('currentMapName').textContent = thematicMaps[theme].name;

            // Update description
            document.getElementById('styleDescription').textContent = thematicMaps[theme].description;

            // Update legend
            updateLegend(theme);

            // Show notification
            showNotification('Switched to: ' + thematicMaps[theme].name);
        }

        // Apply Cesium 3D Tiles style
        function applyThematicStyle(theme) {
            const config = thematicMaps[theme];

            buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                color: config.style.color,
                show: true
            });

            // Force style update
            buildingsTileset.makeStyleDirty();
        }

        // Update legend display
        function updateLegend(theme) {
            const legendItems = document.getElementById('legendItems');
            const config = thematicMaps[theme];

            legendItems.innerHTML = '';

            config.legend.forEach(item => {
                const div = document.createElement('div');
                div.className = 'legend-item';
                div.innerHTML = `
                    <div class="legend-color" style="background: ${item.color};"></div>
                    <span class="legend-label">${item.label}</span>
                `;
                legendItems.appendChild(div);
            });
        }

        // Show notification toast
        function showNotification(message) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            text.textContent = message;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 2500);
        }

        // Fly to Avondale
        function flyToAvondale() {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(
                    AVONDALE_CENTER.longitude,
                    AVONDALE_CENTER.latitude,
                    2500
                ),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0
                },
                duration: 2
            });
        }

        // Reset view
        function resetView() {
            flyToAvondale();
            showNotification('View reset to Avondale center');
        }

        // Initialize legend on load
        updateLegend('height');

        // Start the application
        initViewer();
    </script>
</body>
</html>
